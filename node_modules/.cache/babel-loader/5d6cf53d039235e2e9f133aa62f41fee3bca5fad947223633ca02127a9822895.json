{"ast":null,"code":"import React,{Component,createRef}from\"react\";import{Modal,Button,message}from\"antd\";import{PostForm}from\"./PostForm\";import axios from\"axios\";import{BASE_URL,TOKEN_KEY}from\"../constants\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";class CreatePostButton extends Component{constructor(){super(...arguments);this.state={visible:false,confirmLoading:false};this.showModal=()=>{this.setState({visible:true});};this.handleOk=()=>{this.setState({confirmLoading:true});// get form data\nthis.postForm//查看是否所有必须要填的部分有value\n.validateFields().then(form=>{//从form中拿到上传的信息\nconst{description,uploadPost}=form;const{type,originFileObj}=uploadPost[0];const postType=type.match(/^(image|video)/g)[0];//如果上传的类型已经被定义了\nif(postType){//JS自带的formData的Api\nlet formData=new FormData();formData.append(\"message\",description);formData.append(\"media_file\",originFileObj);const opt={method:\"POST\",url:\"\".concat(BASE_URL,\"/upload\"),headers:{Authorization:\"Bearer \".concat(localStorage.getItem(TOKEN_KEY))},data:formData};axios(opt).then(res=>{if(res.status===200){message.success(\"Successfully uploaded!\");//清空form\nthis.postForm.resetFields();//关闭上传界面\nthis.handleCancel();//如果上传image自动转到image界面\nthis.props.onShowPost(postType);//不再loading\nthis.setState({confirmLoading:false});}}).catch(err=>{console.log(\"Upload failed: \",err.message);message.error(\"Failed to upload\");this.setState({confirmLoading:false});});}}).catch(err=>{console.log(\"err ir validate form -> \",err);});};this.handleCancel=()=>{console.log(\"Clicked cancel button\");this.setState({visible:false});};}render(){const{visible,confirmLoading}=this.state;return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Button,{type:\"primary\",onClick:this.showModal,children:\"New Post\"}),/*#__PURE__*/_jsx(Modal,{title:\"Upload a New Post\",visible:visible,onOk:this.handleOk,okText:\"Upload\",confirmLoading:confirmLoading,onCancel:this.handleCancel,children:/*#__PURE__*/_jsx(PostForm,{ref:refInstance=>this.postForm=refInstance})})]});}}export default CreatePostButton;","map":{"version":3,"names":["React","Component","createRef","Modal","Button","message","PostForm","axios","BASE_URL","TOKEN_KEY","jsx","_jsx","jsxs","_jsxs","CreatePostButton","constructor","arguments","state","visible","confirmLoading","showModal","setState","handleOk","postForm","validateFields","then","form","description","uploadPost","type","originFileObj","postType","match","formData","FormData","append","opt","method","url","concat","headers","Authorization","localStorage","getItem","data","res","status","success","resetFields","handleCancel","props","onShowPost","catch","err","console","log","error","render","children","onClick","title","onOk","okText","onCancel","ref","refInstance"],"sources":["/Users/yuxuan/Desktop/projects/around-web/src/components/CreatePostButton.js"],"sourcesContent":["import React, { Component, createRef } from \"react\";\nimport { Modal, Button, message } from \"antd\";\nimport { PostForm } from \"./PostForm\";\nimport axios from \"axios\";\n\nimport { BASE_URL, TOKEN_KEY } from \"../constants\";\n\nclass CreatePostButton extends Component {\n state = {\n   visible: false,\n   confirmLoading: false\n };\n\n showModal = () => {\n   this.setState({\n     visible: true\n   });\n };\n\n handleOk = () => {\n   this.setState({\n     confirmLoading: true\n   });\n\n   // get form data\n   this.postForm\n     //查看是否所有必须要填的部分有value\n     .validateFields()\n     .then((form) => {\n        //从form中拿到上传的信息\n       const { description, uploadPost } = form;\n       const { type, originFileObj } = uploadPost[0];\n       const postType = type.match(/^(image|video)/g)[0];\n       //如果上传的类型已经被定义了\n       if (postType) {\n        //JS自带的formData的Api\n         let formData = new FormData();\n         formData.append(\"message\", description);\n         formData.append(\"media_file\", originFileObj);\n\n         const opt = {\n           method: \"POST\",\n           url: `${BASE_URL}/upload`,\n           headers: {\n             Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}`\n           },\n           data: formData\n         };\n\n         axios(opt)\n           .then((res) => {\n             if (res.status === 200) {\n               message.success(\"Successfully uploaded!\");\n               //清空form\n               this.postForm.resetFields();\n               //关闭上传界面\n               this.handleCancel();\n               //如果上传image自动转到image界面\n               this.props.onShowPost(postType);\n               //不再loading\n               this.setState({ confirmLoading: false });\n             }\n           })\n           .catch((err) => {\n             console.log(\"Upload failed: \", err.message);\n             message.error(\"Failed to upload\");\n             this.setState({ confirmLoading: false });\n           });\n       }\n     })\n     .catch((err) => {\n       console.log(\"err ir validate form -> \", err);\n     });\n };\n\n handleCancel = () => {\n   console.log(\"Clicked cancel button\");\n   this.setState({\n     visible: false\n   });\n };\n\n render() {\n   const { visible, confirmLoading } = this.state;\n   return (\n     <div>\n       <Button type=\"primary\" onClick={this.showModal}>\n         New Post\n       </Button>\n       <Modal\n         title=\"Upload a New Post\"\n         visible={visible}\n         onOk={this.handleOk}\n         okText=\"Upload\"\n         confirmLoading={confirmLoading}\n         onCancel={this.handleCancel}\n       >\n        <PostForm ref={(refInstance) => (this.postForm = refInstance)} />\n       </Modal>\n     </div>\n   );\n }\n}\nexport default CreatePostButton;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}